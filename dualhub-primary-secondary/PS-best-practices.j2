{#
  This script includes all the best practices from the PS team when they deploy SD-WAN projects for customers. 
  IPsec
  BGP
  SD-WAN

  It will need the following data from the device and the overlay template CSV: 
  - number of hubs
  - number of underlays
  - as_id from the overlay template, {{overlay_variables.as_id}}
#}

{# IPsec 
    [number of hubs] x [number of underlays] = number of phase1-interface/phase2-interface
    The naming convention is "HUBx-VPNx". 
    The following is the example.
#}

config vpn ipsec phase1-interface
  edit "HUB1-VPN1"
    dpd-retrycount 3
    dpd-retryinterval 3
    exchange-fgt-device-id enable
    dhgrp 14 20 21

    {# Branch only options #}
    {% if device.hub_branch == "Branch" %}
      auto-discovery-shortcuts dependent
      idle-timeoutinterval 5
      keylife 14400
    {% endif %}

    {# Hub only options #}
    {% if device.hub_branch == "Hub" %}
      keylife 28800
    {% endif %}
  next
end

config vpn ipsec phase2-interface
  edit "HUB1-VPN1"
    dhgrp 14
    replay disable

    {# Branch only options #}
    {% if device.hub_branch == "Branch" %}
      keylifeseconds 7200
    {% endif %}

    {# Hub only options #}
    {% if device.hub_branch == "Hub" %}
      keylifeseconds 14400
      keepalive enable
    {% endif %}
  next
end

{% if device.hub_branch == "Branch" %}
config router prefix-list
    edit "ONLY_DEFAULT"
        config rule
            edit 1
                set prefix 0.0.0.0 0.0.0.0
                unset ge
                unset le
            next
        end
    next
    edit "PL_BRANCH_LOCAL_PREFIX"
        config rule
            edit 1
                set prefix 10.10.110.0 255.255.255.0
                unset ge
                unset le
            next
            edit 100
                set action deny
                set prefix 0.0.0.0 0.0.0.0
                unset ge
                unset le
            next
        end
    next
    edit "PL_LOOPBACK_SUBNET"
        config rule
            edit 1
                set prefix 172.16.1.0 255.255.255.0   // need to check if this is the overlay network from SOT or overlay CSV
                unset ge
                unset le
            next
        end
    next
    edit "PL_RFC1918_EXACT_MATCH"
        config rule
            edit 10
                set prefix 172.16.0.0 255.240.0.0 // need to cehck if this can be hardcoded? 
                unset ge
                unset le
            next
            edit 20
                set prefix 10.0.0.0 255.0.0.0
                unset ge
                unset le
            next
            edit 30
                set prefix 192.168.0.0 255.255.0.0
                unset ge
                unset le
            next
        end
    next
end

config router route-map
    edit "RTMAP_IN_DYN_BGP"
        config rule
            edit 10
                set action deny
                set match-ip-address "PL_RFC1918_EXACT_MATCH"
                unset set-ip-prefsrc
            next
            edit 100
                unset set-ip-prefsrc
                set set-route-tag 100
            next
        end
    next
    edit "RTMAP_IN_HUB1"             // HUB<N>, depends on the number of HUBs, the content is the same
        config rule
            edit 10
                set action deny
                set match-ip-address "PL_RFC1918_EXACT_MATCH"
                unset set-ip-prefsrc
            next
            edit 100
                unset set-ip-prefsrc
                set set-tag 1
                set set-route-tag 1
            next
        end
    next
    edit "RTMAP_IN_HUB2"      // HUB<N>, depends on the number of HUBs, the content is the same
        config rule
            edit 10
                set action deny
                set match-ip-address "PL_RFC1918_EXACT_MATCH"
                unset set-ip-prefsrc
            next
            edit 100
                unset set-ip-prefsrc
                set set-tag 2
                set set-route-tag 2
            next
        end
    next
    edit "RTMAP_OUT"
        config rule
            edit 10
                set set-community "65100:100"            // 65100 is the as-id, use variable from the overlay CSV,use the variable here: {{overlay_variables.as_id}}
                unset set-ip-prefsrc
            next
        end
    next
end

config router bgp
  set keepalive-timer 10
  holdtime-timer 30
      config neighbor
        edit "172.16.1.251"  // hub's loopback IP, if two hubs, one hub, check the number
          capability-dynamic enable
          advertisement-interval 2
          next-hop-self enable
          connect-timer 2
          route-map-in RTMAP_IN_HUBN // Please check the config router route-map section above.
          route-map-out RTMAP_OUT
          unset route-map-out-preferable
        next
        edit "172.16.1.252"  // hub's loopback IP, if two hubs, one hub, check the number
          capability-dynamic enable
          advertisement-interval 2
          next-hop-self enable
          connect-timer 2
          route-map-in RTMAP_IN_HUB2 // // Please check the config router route-map section above.
          route-map-out RTMAP_OUT
          unset route-map-out-preferable
        next
      end
      config neighbor-group
          edit "DYN_EDGE"    // SOT hardcoded name
              capability-graceful-restart enable // need Olesya to confirm
              capability-dynamic enable
              advertisement-interval 2
              connect-timer 2
              route-map-in RTMAP_IN_DYN_BGP
              route-map-out RTMAP_OUT
              unset prefix-list-out
        next
      end
end
{% endif %}

{% if device.hub_branch == "Hub" %}
config router prefix-list
    edit "LOOPBACK_RANGE"  
        config rule
            edit 1
                set prefix 172.16.1.0 255.255.255.0    // need to check if this is the overlay network from SOT or overlay CSV
                unset ge
                unset le
            next
        end
    next
    edit "PL_DC_SUBNETS"
        config rule
            edit 1
                set prefix 10.100.100.1 255.255.255.255
                unset ge
                unset le
            next
        end
    next
    edit "PL_RFC1918_EXACT_MATCH"
        config rule
            edit 10
                set prefix 172.16.0.0 255.240.0.0
                unset ge
                unset le
            next
            edit 20
                set prefix 10.0.0.0 255.0.0.0
                unset ge
                unset le
            next
            edit 30
                set prefix 192.168.0.0 255.255.0.0
                unset ge
                unset le
            next
        end
    next
    edit "PL_ONLY_DEFAULT"
        config rule
            edit 1
                set prefix 0.0.0.0 0.0.0.0
                unset ge
                unset le
            next
        end
    next
    edit "PL_AGGREGATE_10/8"
        config rule
            edit 1
                set prefix 10.0.0.0 255.0.0.0
                unset ge
                unset le
            next
        end
    next
    edit "PL_RFC1918-FULL_RANGE"
        config rule
            edit 10
                set prefix 172.16.0.0 255.240.0.0
                unset ge
                set le 32
            next
            edit 20
                set prefix 10.0.0.0 255.0.0.0
                unset ge
                set le 32
            next
            edit 30
                set prefix 192.168.0.0 255.255.0.0
                unset ge
                set le 32
            next
        end
    next
end

config router route-map
    edit "RTMAP_IN_ALL_OVERLAYS"
        config rule
            edit 5
                set action deny
                set match-ip-address "PL_ONLY_DEFAULT"
                unset set-ip-prefsrc
            next
            edit 10
                set action deny
                set match-ip-address "PL_RFC1918_EXACT_MATCH"
                unset set-ip-prefsrc
            next
            edit 100
                unset set-ip-prefsrc
            next
        end
    next
    edit "RTMAP_OUT_ALL_OVERLAYS"
        config rule
            edit 5
                set match-ip-address "LOOPBACK_RANGE"
                set set-community "65100:1"            // 65100 is the as-id, use variable from the overlay CSV,use the variable here: {{overlay_variables.as_id}}
                unset set-ip-prefsrc
            next
            edit 100
                set action deny
                unset set-ip-prefsrc
            next
            edit 3
                set match-ip-address "PL_DC_SUBNETS"
                set set-community "65100:1"       // 65100 is the as-id, use variable from the overlay CSV,use the variable here: {{overlay_variables.as_id}}
                unset set-ip-prefsrc
            next
        end
    next
    edit "RTMAP_OUT_CORE_SIDE"
        config rule
            edit 5
                set action deny
                set match-ip-address "PL_ONLY_DEFAULT"
                unset set-ip-prefsrc
            next
            edit 10
                set action deny
                set match-ip-address "PL_RFC1918_EXACT_MATCH"
                unset set-ip-prefsrc
            next
            edit 100
                set action deny
                unset set-ip-prefsrc
            next
            edit 15
                set match-community "COMMUNITY_BRANCHES_OV1_PASS"
                unset set-ip-prefsrc
            next
            edit 20
                set match-community "COMMUNITY_BRANCHES_ALL_OV_FAIL"
                unset set-ip-prefsrc
            next
        end
    next
end

config router bgp
  set keepalive-timer 10
  holdtime-timer 30
  
  config aggregate-address
    edit 1
      set prefix 172.16.1.0 255.255.255.0 // 172.16.1.0, need to check if it's hardcoded or comes from the overlay template
      set summary-only enable
    next
  end

  config neighbor-group
    edit "EDGE"                  // SOT hardcoded name
      capability-dynamic enable
      advertisement-interval 2
      connect-timer 2
      route-map-in RTMAP_IN_ALL_OVERLAYS
      route-map-out RTMAP_OUT_ALL_OVERLAYS
    next
  end
end
{% endif %}

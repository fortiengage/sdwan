{% set device = device_data[Name]%}
 
config system global
    set hostname "{{ device.Name }}"
    set alias "{{ device.Name }}"
    {% if device.longitude is defined %}
        set gui-device-longitude "{{ device.longitude }}"
        set gui-device-latitude "{{ device.latitude }}"
    {% endif %}
    {% if device.timezone is defined and device.timezone %}
        set timezone "{{device.timezone}}"
    {% endif %}
end
 
config system interface
    {# if device.mgmt_intf_name is defined and device.mgmt_intf_ip is defined #}
    {% if device.mgmt_intf_name | default('') and device.mgmt_intf_ip | default('') %}
        edit "{{device.mgmt_intf_name}}"
            set vdom root
            set mode static
            set ip "{{device.mgmt_intf_ip}}"
            set allowaccess ping https ssh fgfm
            set role wan
        next
    {% endif %}

    {# Create and set WAN interfaces #}
    {% for intf in device.isp_intf %}
        {% set ns = namespace(port_str = "") %}
        {% if intf.ports is defined %}
            {% for port in intf.ports %}
                {% set ns.port_str = ns.port_str + port + " " %}
            {% endfor %}
        {% endif %}
        edit "{{intf.name}}"
            set vdom "{{intf.vdom | default('root')}}"
            set type {{intf.type}}
            {% if ns.port_str != "" %}
            set member {{ns.port_str | trim}}
            {% endif %}
            set mode {{intf.mode}}
            {% if intf.mode == 'static' %}
            set ip "{{intf.ip}} {{intf.network_mask}}"
            {% endif %}
            set role {{intf.role | default('wan')}}
            {% if intf.type == 'vlan' %}
            set interface "{{intf.interface}}"
            set vlanid {{intf.vlan_id}}
            {% endif %}
            set description "Underlay Interface by FENG on UTC {{ date_time }}"
        next
    {% endfor %}

    {# Create and set LAN interfaces #}
    {% for intf in device.lan_intf %}
        {% set ns = namespace(port_str = "") %}
        {% if intf.ports is defined %}
            {% for port in intf.ports %}
                {% set ns.port_str = ns.port_str + port + " " %}
            {% endfor %}
        {% endif %}
        edit "{{intf.name}}"
            set vdom "{{intf.vdom | default('root')}}"
            set type {{intf.type}}
            {% if ns.port_str != "" %}
            set member {{ns.port_str | trim}}
            {% endif %}
            set mode {{intf.mode}}
            {% if intf.mode == 'static' %}
            set ip "{{intf.ip}} {{intf.network_mask}}"
            {% endif %}
            set role {{intf.role | default('wan')}}
            {% if intf.type == 'vlan' %}
            set interface "{{intf.interface}}"
            set vlanid {{intf.vlan_id}}
            {% endif %}
            set role lan
            set description "Underlay Interface by FENG on UTC {{ date_time }}"
        next
    {% endfor %}

end
 
config router static
    {% if device.mgmt_intf_name | default('') and device.mgmt_dst_fmg_ip_networkmask | default('') and device.mgmt_dst_gateway_ip | default('') %}
        edit 1
            set dst "{{device.mgmt_dst_fmg_ip_networkmask}}"
            set gateway "{{device.mgmt_dst_gateway_ip}}"
            set device "{{device.mgmt_intf_name}}"
        next
    {% endif %}

{% if device.hub_branch == "Hub" %}
    {% set ns = namespace(router_index = 2) %}
    {% for intf in device.isp_intf %}
        {% if intf.gateway is defined %}
            edit {{ns.router_index}}
                set gateway "{{intf.gateway}}"
                set device "{{intf.name}}"
            next
            {% set ns.router_index = ns.router_index + 1 %}
        {% endif %}
    {% endfor %}
{% endif %}

end
 
{% if device.hub_branch == "Hub" %}
    config router policy
    {% for intf in device.isp_intf %}
        edit {{loop.index}}
            set input-device "VPN{{loop.index}}"
            set output-device "VPN{{loop.index}}"
        next
    {% endfor %}
    end
{% endif %}
